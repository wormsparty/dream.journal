{% extends 'base.html' %}

{% block header %}
{% endblock %}

{% block content %}
    <div id="top-menu" class="content">
        <div class="pure-menu pure-menu-horizontal">
            <ul class="pure-menu-list">
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">Test 1</a></li>
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">Test 2</a></li>
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">Test 3</a></li>
            </ul>
        </div>
    </div>
    <div id="left-menu" class="content">
        <div class="pure-menu" style="height: 100%">
            <div style="height: 20px"></div>
            <ul id="subjectlist" class="pure-menu-list">
                <!-- Populated dynamically -->
            </ul>
            <div style="left: 50px; bottom: 0; position: absolute">
                <button class="primary-button pure-button" data-micromodal-trigger="modal-create" style="background: transparent">
                    <span style="color: #777; font-size: 20px">
                        +
                    </span>
                </button>
            </div>
        </div>
    </div>
    <div id="right-menu" class="content">
        <div class="pure-menu">
            <ul id="elementslist" class="pure-menu-list">
                <li class="pure-menu-heading">
                    <div style="height: 20px"></div>
                </li>
            </ul>
            <div class="centered">
                <button class="primary-button pure-button" style="background: transparent" onclick="ajouter_subject()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="content" class="content">
        <div style="height: 45px"></div>
        <form class="pure-form">
            <textarea class="text-content" wrap="hard" style="bottom: 20px"></textarea>
        </form>
    </div>
    <div class="modal micromodal-slide" id="modal-create" aria-hidden="true">
        <div class="modal_overlay" tabindex="-1" data-micromodal-close>
            <div class="modal_container" role="dialog" aria-modal="true" aria-labelledby="modal-create-title">
                <header class="modal_header">
                    <h2 class="modal_title" id="modal-create-title">
                        Ajout de sujet
                    </h2>
                </header>
                <main class="modal_content" id="modal-create-content">
                    <form class="pure-form">
                        <button id="ajouter_couleur" class="jscolor pure-button" style="width: 30px; height: 30px; background-color: rgb(255, 255, 255);" type="button">#FFFFFF</button>
                        <input id="ajouter_sujet" class="search-bar" style="width: 360px; left: inherit; border: 1px solid #000; box-shadow: none; margin-left: 3px"/>
                        <div style="height: 30px"></div>
                        <button class="primary-button pure-button" style="margin-left: 300px" onclick="ajouter_subject()" data-micromodal-close>Ajouter</button>
                    </form>
                </main>
                <footer class="modal_footer">
                </footer>
            </div>
        </div>
    </div>
    <div class="modal micromodal-slide" id="modal-edit" aria-hidden="true">
        <div class="modal_overlay" tabindex="-1" data-micromodal-close>
            <div class="modal_container" role="dialog" aria-modal="true" aria-labelledby="modal-edit-title">
                <header class="modal_header">
                    <h2 class="modal_title" id="modal-edit-title">
                        Éditer sujet
                    </h2>
                </header>
                <main class="modal_content" id="modal-edit-content">
                    <form class="pure-form">
                        <button id="edit_couleur" class="jscolor pure-button" style="width: 30px; height: 30px; background-color: rgb(255, 255, 255);" type="button">#FFFFFF</button>
                        <input id="edit_sujet" class="search-bar" style="width: 360px; left: inherit; border: 1px solid #000; box-shadow: none; margin-left: 3px"/>
                        <div style="height: 30px"></div>
                        <button class="primary-button pure-button" style="margin-left: 300px" onclick="edit_subject()" data-micromodal-close>Sauver</button>
                    </form>
                </main>
                <footer class="modal_footer">
                </footer>
            </div>
        </div>
    </div>
    <div class="contextmenu_subject" id="contextsujet" style="display: none">
        <div id="to_delete_subject" style="display: none"></div>
        <ul class="pure-menu-list" style="border: 1px solid #DDD;">
            <li id="edit_subject" class="pure-menu-item centered" style="background: #EEE;">
                <a href="#" class="pure-menu-link" data-micromodal-trigger="modal-edit">Éditer</a>
            </li>
            <li id="delete_subject" class="pure-menu-item centered" style="background: #EEE;">
                <a href="#" class="pure-menu-link">Supprimer</a>
            </li>
        </ul>
    </div>

    <script type="text/javascript">
        function add_subject(subject_list, subject) {
            subject_list.innerHTML += '<li class="pure-menu-item">' +
                    '<a href="#" id="' + subject.uid + '" class="pure-menu-link deletable_subject" style="color: ' + subject.color + '">' +
                        subject.subject +
                    '</a>' +
               '</li>';
        }

        function ajouter_subject(e) {
            let data = {
                subject: $('#ajouter_sujet').val(),
                color: $('#ajouter_couleur').text()
            };

            if (data.subject !== undefined && data.subject.trim() !== '') {
                $.post('/add_subject', data, function(r) {
                    data.uid = r;
                    add_subject($('#subjectlist')[0], data);
                    $(".deletable_subject").contextmenu(delete_context);
                });
            }
        }

        function delete_context(e)
        {
            let context = $('#contextsujet')[0];

            context.style.display = 'block';
            context.style.left = e.pageX + 'px';
            context.style.top = e.pageY + 'px';

            console.log(e.target.id);

            $('#to_delete_subject').text(e.target.id);
            e.preventDefault();
        }

        var onresize = function() {
            var h = Math.max($(window).height(), $(document).height());

            var left = document.getElementById('left-menu');
            left.style.height = h - $('#left-menu').offset().top + 'px';

            var right = document.getElementById('right-menu');
            right.style.height = h - $('#right-menu').offset().top + 'px';

            var content = document.getElementById('content');
            content.style.height = h - $('#content').offset().top + 'px';
        };

        $(document).ready(function()
        {
            onresize();
            $(window).resize(onresize);

            var textarea = document.querySelector('textarea');

            function onchange (e) {
                var el = this;

                if (e.keyCode === 13)
                {
                    if (!e.shiftKey)
                    {
                        e.preventDefault();
                        alert('TODO: Sumbit to server');
                    }
                }

                setTimeout(function() {
                    el.style.height = el.scrollHeight + 'px';
                }, 0);
            }
            textarea.addEventListener('change', onchange);
            textarea.addEventListener('cut', onchange);
            textarea.addEventListener('paste', onchange);
            textarea.addEventListener('drop', onchange);
            textarea.addEventListener('keydown', onchange);
            textarea.addEventListener('keyup', onchange);

            $('#edit_subject').on('click', function() {
                let to_edit = $('#to_edits_subject').text();

                // TODO!
            });

            $('#delete_subject').on('click', function() {
                let to_del = $('#to_delete_subject').text();

                $.post('/delete_subject', { 'uid': to_del}, function(data) {
                    // TODO: ENLEVER CA !!
                    // TODO: AFFICHER UN MESSAGE SI RATE (SI ASSIGNE A UN DOCUMENT!)
                    location.reload();
                });
            });

            $('body').on('click', function() {
                let context = $('#contextsujet')[0];
                context.style.display = 'none';
            });

            $.post('/get_subjects', null, function(data)
            {
                let json = JSON.parse(data);
                let subject_list = $('#subjectlist')[0];

                add_subject(subject_list, {
                    uid: "0",
                    subject: 'Journal',
                    color: '#4174c1'
                });

                for(let i = 0; i < json.length; i++)
                    add_subject(subject_list, json[i]);

                $(".deletable_subject").contextmenu(delete_context);

                MicroModal.init();
            });
        });
    </script>
{% endblock %}